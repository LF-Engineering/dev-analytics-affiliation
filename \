package elastic

import (
	"fmt"

	"github.com/LF-Engineering/dev-analytics-affiliation/gen/models"
	"github.com/elastic/go-elasticsearch/v7"

	log "github.com/LF-Engineering/dev-analytics-affiliation/logging"
)

// Service - interface to access ES data
type Service interface {
	// External methods
	GetUnaffiliated(string) (*models.GetUnaffiliatedOutput, error)
	// Internal methods
	toLocalUnaffiliated(*models.GetUnaffiliatedOutput) []interface{}
}

type service struct {
	client *elasticsearch.Client
}

// New return ES connection
func New(client *elasticsearch.Client) Service {
	return &service{
		client: client,
	}
}

func (s *service) GetUnaffiliated(projectSlug string) (getUnaffiliated *models.GetUnaffiliatedOutput, err error) {
  log.Info(fmt.Sprintf("GetUnaffiliated: projectSlug:%s", projectSlug)
	getUnaffiliated = &models.GetUnaffiliatedOutput{}
	defer func() {
		log.Info(
			fmt.Sprintf(
        "GetUnaffiliated(exit): projectSlug:%s getUnaffiliated:%+v err:%v",
        projectSlug,
				s.toLocalUnaffiliated(getUnaffiliated),
				err,
			),
		)
	}()
  //idx="sds-${1//\//-}"
  //${idx}-*,-${idx}-*-raw
  pattern := projectSlug
  if strings.StartsWith(pattern, "

	//getUnaffiliated.Unaffiliated = ary
	return
}

func (s *service) toLocalUnaffiliated(ia *models.GetUnaffiliatedOutput) (oa []interface{}) {
	for _, i := range ia.Unaffiliated {
		if i == nil {
			oa = append(oa, nil)
			continue
		}
		oa = append(oa, *i)
	}
	return
}
